<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Calibration · TumorGrowth.jl</title><meta name="title" content="Calibration · TumorGrowth.jl"/><meta property="og:title" content="Calibration · TumorGrowth.jl"/><meta property="twitter:title" content="Calibration · TumorGrowth.jl"/><meta name="description" content="Documentation for TumorGrowth.jl."/><meta property="og:description" content="Documentation for TumorGrowth.jl."/><meta property="twitter:description" content="Documentation for TumorGrowth.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">TumorGrowth.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Overview</a></li><li><a class="tocitem" href="../installation/">Installation</a></li><li><a class="tocitem" href="../quick_start/">Quick start</a></li><li class="is-active"><a class="tocitem" href>Calibration</a><ul class="internal"><li><a class="tocitem" href="#Overview"><span>Overview</span></a></li><li><a class="tocitem" href="#Usage"><span>Usage</span></a></li></ul></li><li><a class="tocitem" href="../comparison/">Model comparison</a></li><li><span class="tocitem">Extended examples</span><ul><li><a class="tocitem" href="../examples/03_calibration/notebook/">Calibration workflows</a></li><li><a class="tocitem" href="../examples/04_model_battle/notebook/">Model battle</a></li></ul></li><li><a class="tocitem" href="../api/">Adding new models</a></li><li><a class="tocitem" href="../reference/">Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Calibration</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Calibration</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/ablaom/TumorGrowth.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/ablaom/TumorGrowth.jl/blob/dev/docs/src/calibration.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Calibration"><a class="docs-heading-anchor" href="#Calibration">Calibration</a><a id="Calibration-1"></a><a class="docs-heading-anchor-permalink" href="#Calibration" title="Permalink"></a></h1><p>For a basic example, see the <a href="#TumorGrowth.CalibrationProblem"><code>CalibrationProblem</code></a> document string below. For an extended workflow, see <a href="../examples/03_calibration/notebook/#Calibration-workflows">Calibration workflows</a>.</p><h2 id="Overview"><a class="docs-heading-anchor" href="#Overview">Overview</a><a id="Overview-1"></a><a class="docs-heading-anchor-permalink" href="#Overview" title="Permalink"></a></h2><p>By default, calibration is performed using a gradient descent optimiser to minimise a least-squares error on provided clinical measurements, and uses the adjoint method to auto-differentiate solutions to the underlying ODE&#39;s, with respect to the ODE parameters, and initial conditions to be optimised. Alternatively, Levengerg-Marquardt or Powell&#39;s dog leg optimisation may be employed. This can be faster for the smaller models, but enjoys fewer features.</p><h3 id="Gradient-descent-optimisation"><a class="docs-heading-anchor" href="#Gradient-descent-optimisation">Gradient descent optimisation</a><a id="Gradient-descent-optimisation-1"></a><a class="docs-heading-anchor-permalink" href="#Gradient-descent-optimisation" title="Permalink"></a></h3><p>Calibration using a gradient descent optimiser has these advantages:</p><ul><li><p>Any updater (<code>optimiser</code>) from <a href="https://fluxml.ai/Optimisers.jl/dev/">Optimisers.jl</a> can be used.</p></li><li><p>Fine-grained control of iteration, including live plots, is possible using <a href="https://github.com/JuliaAI/IterationControl.jl">IterationControl.jl</a>.</p></li><li><p>Stability issues for models with a singularity at zero volume can be mitigated by specifying a loss <code>penalty</code>.</p></li><li><p>Instead of minimizing a least-squares loss, one can give more weight to recent observations by specifying an appropriate <code>half_life</code>.</p></li><li><p>Convergence may be faster for models with a large number of parameters (e.g., larger neural ODE models)</p></li><li><p>Models can be calibrated even if the number of observations is less than the number of model parameters.</p></li></ul><p>By default, optimisation is by gradient descent using Adaptive Moment Estimation and a user-specifiable <code>learning_rate</code>.</p><h3 id="Levengerg-Marquardt-/-dog-leg-optimisation"><a class="docs-heading-anchor" href="#Levengerg-Marquardt-/-dog-leg-optimisation">Levengerg-Marquardt / dog leg optimisation</a><a id="Levengerg-Marquardt-/-dog-leg-optimisation-1"></a><a class="docs-heading-anchor-permalink" href="#Levengerg-Marquardt-/-dog-leg-optimisation" title="Permalink"></a></h3><p>The main advantage of these methods is that they are faster for all the models currently provided, with the exception of large neural ODE models. Users can specify an initial <code>trust_region_radius</code> to mitigate instability.</p><h2 id="Usage"><a class="docs-heading-anchor" href="#Usage">Usage</a><a id="Usage-1"></a><a class="docs-heading-anchor-permalink" href="#Usage" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="TumorGrowth.CalibrationProblem" href="#TumorGrowth.CalibrationProblem"><code>TumorGrowth.CalibrationProblem</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">    CalibrationProblem(times, volumes, model; learning_rate=0.0001, options...)</code></pre><p>Specify a problem concerned with optimizing the parameters of a tumor growth <code>model</code>, given measured <code>volumes</code> and corresponding <code>times</code>.</p><p>See <a href="../reference/#TumorGrowth.TumorGrowth"><code>TumorGrowth</code></a> for a list of possible <code>model</code>s.</p><p>Default optimisation is by Adam gradient descent, using a sum of squares loss. Call <code>solve!</code> on a problem to carry out optimisation, as shown in the example below. See &quot;Extended Help&quot; for advanced options, including early stopping.</p><p>Initial values of the parameters are inferred by default.</p><p>Unless frozen (see &quot;Extended help&quot; below), the calibration process learns an initial condition <code>v0</code> which is generally different from <code>volumes[1]</code>.</p><p><strong>Simple solve</strong></p><pre><code class="language-julia hljs">using TumorGrowth

times = [0.1, 6.0, 16.0, 24.0, 32.0, 39.0]
volumes = [0.00023, 8.4e-5, 6.1e-5, 4.3e-5, 4.3e-5, 4.3e-5]
problem = CalibrationProblem(times, volumes, gompertz; learning_rate=0.01)
solve!(problem, 30)    # apply 30 gradient descent updates
julia&gt; loss(problem)   # sum of squares loss
1.7341026729860452e-9

p = solution(problem)
julia&gt; pretty(p)
&quot;v0=0.0002261  v∞=2.792e-5  ω=0.05731&quot;


extended_times = vcat(times, [42.0, 46.0])
julia&gt; gompertz(extended_times, p)[[7, 8]]
2-element Vector{Float64}:
 3.374100207406809e-5
 3.245628908921241e-5</code></pre><p><strong>Extended help</strong></p><p><strong>Solving with iteration controls</strong></p><p>Continuing the example above, we may replace the number of iterations, <code>n</code>, in <code>solve!(problem, n)</code>, with any control from IterationControl.jl:</p><pre><code class="language-julia hljs">using IterationControl
solve!(
  problem,
  Step(1),            # apply controls every 1 iteration...
  WithLossDo(),       # print loss
  Callback(problem -&gt; print(pretty(solution(problem)))), # print parameters
  InvalidValue(),     # stop for ±Inf/NaN loss
  NumberSinceBest(5), # stop when lowest loss so far was 5 steps prior
  TimeLimit(1/60),    # stop after one minute
  NumberLimit(400),   # stop after 400 steps
)
p = solution(problem)
julia&gt; loss(problem)
7.609310030658547e-10</code></pre><p>See <a href="https://github.com/JuliaAI/IterationControl.jl">IterationControl.jl</a> for all options.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Controlled iteration as above is not recommended if you specify <code>optimiser=LevenbergMarquardt()</code> or <code>optimiser=Dogleg()</code> because the internal state of these optimisers is reset at every <code>Step</code>. Instead, to arrange automatic stopping, use <code>solve!(problem, 0)</code>.</p></div></div><p><strong>Visualizing results</strong></p><pre><code class="language-julia hljs">using Plots
scatter(times, volumes, xlab=&quot;time&quot;, ylab=&quot;volume&quot;, label=&quot;train&quot;)
plot!(problem, label=&quot;prediction&quot;)</code></pre><p><strong>Keyword options</strong></p><ul><li><p><code>p0=guess_parameters(times, volumes, model)</code>: initial value of the model parameters.</p></li><li><p><code>lower</code>: named tuple indicating lower bounds on components of the model parameter <code>p</code>. For example, if <code>lower=(; v0=0.1)</code>, then this introduces the constraint <code>p.v0 &lt; 0.1</code>. The model-specific default value is <a href="../reference/#TumorGrowth.lower_default-Tuple{Any}"><code>TumorGrowth.lower_default(model)</code></a>.</p></li><li><p><code>upper</code>: named tuple indicating upper bounds on components of the model parameter <code>p</code>. For example, if <code>upper=(; v0=100)</code>, then this introduces the constraint <code>p.v0 &lt; 100</code>. The model-specific default value is <a href="../reference/#TumorGrowth.upper_default-Tuple{Any}"><code>TumorGrowth.upper_default(model)</code></a>.</p></li><li><p><code>frozen</code>: a named tuple, such as <code>(; v0=nothing, λ=1/2)</code>; indicating parameters to be frozen at specified values during optimisation; a <code>nothing</code> value means freeze at initial value. The model-specific default value is <a href="../reference/#TumorGrowth.frozen_default-Tuple{Any}"><code>TumorGrowth.frozen_default(model)</code></a>.</p></li><li><p><code>learning_rate &gt; 0</code>: learniing rate for Adam gradient descent optimisation. Ignored if <code>optimiser</code> is explicitly specified.</p></li><li><p><code>optimiser</code>: optimisation algorithm, which will be one of two varieties:</p><ul><li><p>A gradient descent optimiser: This must be from Optimisers.jl or implement the same API.</p></li><li><p>A Gauss-Newton optimiser: Either <code>LevenbergMarquardt()</code>, <code>Dogleg()</code>, provided by LeastSquaresOptim.jl (but re-exported by <code>TumorGrowth</code>).</p></li></ul><p>The model-specific default value is <a href="../reference/#TumorGrowth.optimiser_default-Tuple{Any}"><code>TumorGrowth.optimiser_default(model)</code></a>, unless <code>learning_rate</code> is specified, in which case it will be <code>Optimisers.Adam(learning_rate)</code>.</p></li><li><p><code>scale</code>: a scaling function with the property that <code>p = scale(q)</code> has a value of the same order of magnitude for the model parameters being optimised, whenever <code>q</code> has the same form as a model parameter <code>p</code> but with all values equal to one. Scaling can help components of <code>p</code> converge at a similar rate. Ignored by Gauss-Newton optimisers. Model-specific default is <a href="../api/#TumorGrowth.scale_default"><code>TumorGrowth.scale_default(model)</code></a>.</p></li><li><p><code>radius &gt; 0</code>: initial trust region radius. This is ignored unless <code>optimiser</code> is a Gauss-Newton optimiser. The model-specific default is <a href="../reference/#TumorGrowth.radius_default-Tuple{Any, Any}"><code>TumorGrowth.radius_default(model, optmiser)</code></a>, which is typically <code>10.0</code> for <code>LevenbergMarquardt()</code> and <code>1.0</code> for <code>Dogleg</code>.</p></li><li><p><code>half_life=Inf</code>: set to a real positive number to replace the sum of squares loss with a weighted version; weights decay in reverse time with the specified <code>half_life</code>. Ignored by Gauss-Newton optimisers.</p></li><li><p><code>penalty ≥ 0</code>: the larger the positive value, the more a loss penalty discourages large differences in <code>v0</code> and <code>v∞</code> on a log scale. Helps discourage <code>v0</code> and <code>v∞</code> drifting out of bounds in models whose ODE have a singularity at the origin. Model must include <code>v0</code> and <code>v∞</code> as parameters. Ignored by Gauss-Newton optimisers.  The model-specific default value is <a href="../reference/#TumorGrowth.penalty_default-Tuple{Any}"><code>TumorGrowth.penalty_default(model)</code></a>.</p></li><li><p><code>ode_options...</code>: optional keyword arguments for the ODE solver, <code>DifferentialEquations.solve</code>, from DifferentialEquations.jl. Not relevant for models using analytic solutions (see the table at <a href="../reference/#TumorGrowth.TumorGrowth"><code>TumorGrowth</code></a>).</p></li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/ablaom/TumorGrowth.jl/blob/0d805901765484e42de26d9f860cd9da9ed1c96d/src/calibration.jl#L41-L180">source</a></section><section><div><pre><code class="language-julia hljs">CalibrationProblem(problem; kwargs...)</code></pre><p>Construct a new calibration problem out an existing <code>problem</code> but supply new keyword arguments, <code>kwargs</code>. Unspecified keyword arguments fall back to defaults, except for <code>p0</code>, which falls back to <code>solution(problem)</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/ablaom/TumorGrowth.jl/blob/0d805901765484e42de26d9f860cd9da9ed1c96d/src/calibration.jl#L254-L261">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../quick_start/">« Quick start</a><a class="docs-footer-nextpage" href="../comparison/">Model comparison »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.5.0 on <span class="colophon-date" title="Tuesday 6 August 2024 00:54">Tuesday 6 August 2024</span>. Using Julia version 1.10.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
